// js/modules/mobile-preview.js

const ACCESS_KEY = 'YOUR_ACCESS_KEY'; // Get free at screenshotlayer.com (100/month forever)

export function init(analysisData = {}, testUrl = null) {
  const screenshotImg = document.getElementById('mobile-screenshot');
  const overlayCanvas = document.getElementById('heatmap-overlay');
  const statusEl = document.getElementById('preview-status');
  const issuesEl = document.getElementById('preview-issues');

  if (!screenshotImg || !overlayCanvas) return;

  const url = encodeURIComponent(testUrl || analysisData.url || 'https://example.com');
  const cacheKey = `mobile-preview-${url}`;

  // Cache check (24h)
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    const { image, timestamp } = JSON.parse(cached);
    if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
      loadScreenshot(image);
      drawOverlays(analysisData);
      return;
    }
  }

  statusEl.textContent = 'Capturing mobile view...';

  const apiUrl = `https://api.screenshotlayer.com/api/capture?access_key=${ACCESS_KEY}&url=${url}&viewport=375x812&mobile=1&fullpage=0&format=PNG&force=1`;

  fetch(`https://cors-proxy.traffictorch.workers.dev/?${apiUrl}`)
    .then(res => {
      if (!res.ok) throw new Error('API error');
      return res.blob();
    })
    .then(blob => {
      const imageUrl = URL.createObjectURL(blob);
      loadScreenshot(imageUrl);

      localStorage.setItem(cacheKey, JSON.stringify({ image: imageUrl, timestamp: Date.now() }));

      drawOverlays(analysisData);
      statusEl.textContent = 'iPhone-style mobile emulation';
    })
    .catch(err => {
      console.warn('Preview failed:', err);
      statusEl.innerHTML = 'Preview unavailable<br><span class="text-xs opacity-70">Check API key or try later</span>';
      screenshotImg.src = 'https://via.placeholder.com/375x812/333/fff?text=Mobile+Preview';
    });

  function loadScreenshot(src) {
    screenshotImg.src = src;
    screenshotImg.onload = () => {
      overlayCanvas.width = screenshotImg.clientWidth;
      overlayCanvas.height = screenshotImg.clientHeight;
    };
  }

  function drawOverlays(data) {
    const ctx = overlayCanvas.getContext('2d');
    ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);

    // Example educational heatmaps â€“ map to real analysisData later
    const issues = [
      { rect: [0, 0, 1, 0.15], color: 'rgba(239, 68, 68, 0.4)', label: 'Slow header (LCP)', fix: 'Optimize hero images & fonts' },
      { rect: [0.05, 0.25, 0.9, 0.4], color: 'rgba(234, 179, 8, 0.4)', label: 'Layout shift (CLS)', fix: 'Reserve space for ads/images' },
      { rect: [0.1, 0.7, 0.8, 0.2], color: 'rgba(239, 68, 68, 0.4)', label: 'Small tap targets', fix: 'Min 48px touch areas' }
    ];

    issues.forEach(issue => {
      const [x, y, w, h] = issue.rect;
      ctx.fillStyle = issue.color;
      ctx.fillRect(x * overlayCanvas.width, y * overlayCanvas.height, w * overlayCanvas.width, h * overlayCanvas.height);
    });

    // Educational tap feedback
    overlayCanvas.addEventListener('click', (e) => {
      const rect = overlayCanvas.getBoundingClientRect();
      const clickX = (e.clientX - rect.left) / overlayCanvas.width;
      const clickY = (e.clientY - rect.top) / overlayCanvas.height;

      const hit = issues.find(issue => {
        const [x, y, w, h] = issue.rect;
        return clickX >= x && clickX <= x + w && clickY >= y && clickY <= y + h;
      });

      if (hit) {
        issuesEl.innerHTML = `
          <div class="p-4 bg-red-500/20 dark:bg-red-900/30 rounded-xl border border-red-500">
            <p class="font-bold text-red-400">${hit.label}</p>
            <p class="mt-2">Fix: ${hit.fix}</p>
            <p class="mt-2 text-xs opacity-80">Tap again to close</p>
          </div>
        `;
      } else {
        issuesEl.innerHTML = '';
      }
    });
  }
}