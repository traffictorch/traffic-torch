<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Traffic Torch — Free Pro-Level SEO & UX Audit</title>
  <meta name="description" content="Instant 360° SEO + UX health score using only free unlimited APIs. Real-user data, waterfalls — no limits, no signups." />
  <!-- PWA basics -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1a1a1a" />
  <style>
    :root { --bg: #f8f9fa; --text: #1a1a1a; --card: white; --accent: #0066ff; }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #0d1117; --text: #f0f6fc; --card: #161b22; --accent: #58a6ff; }
    }
    body {
      margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh;
      display: flex; flex-direction: column;
    }
    header, footer { background: rgba(0,0,0,0.05); padding: 1rem; text-align: center; }
    main { flex: 1; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    .input-group { display: grid; gap: 1rem; margin-bottom: 2rem; }
    input, button {
      padding: 0.9rem; font-size: 1rem; border-radius: 8px; border: 1px solid #444;
      background: var(--card); color: var(--text);
    }
    button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: bold; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .report { display: grid; gap: 1.5rem; margin-top: 2rem; }
    .card {
      background: var(--card); border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid #3333;
    }
    .score-big { font-size: 4rem; font-weight: 900; margin: 0; }
    .good { color: #28a745; }
    .avg { color: #ffc107; }
    .poor { color: #dc3545; }
    .filmstrip img { max-width: 100%; border-radius: 8px; margin-top: 1rem; }
    .insights { background: #fff3cd; color: #856404; padding: 1rem; border-radius: 8px; }
    .dark-mode .insights { background: #402c04; color: #ffea9f; }
    #status { text-align: center; font-style: italic; margin: 1rem 0; }
  </style>
</head>
<body>
  <header>
    <h1>Traffic Torch — Free Pro Audit (2025)</h1>
    <p>Real-user data • Visual waterfalls • 100% free & unlimited</p>
  </header>
  <main>
    <!-- REMOVED: Keyword input — no API uses it anymore -->
    <div class="input-group">
      <input type="url" id="url" placeholder="https://example.com" required />
      <button id="run">Run Full Analysis</button>
    </div>

    <div id="status"></div>
    <div id="report" class="report"></div>
  </main>
  <footer>
    <small>Built with free unlimited APIs • Google PageSpeed • CrUX • GTmetrix • No signups, no limits</small>
  </footer>

<script type="module">
  import { runFullAnalysis } from './js/enhanced-analyzer.js';

  const statusEl = document.getElementById('status');
  const reportEl = document.getElementById('report');
  const runBtn = document.getElementById('run');

  runBtn.addEventListener('click', async () => {
    const url = document.getElementById('url').value.trim();
    if (!url) return alert("Please enter a URL");

    runBtn.disabled = true;
    statusEl.textContent = "Starting analysis…";
    reportEl.innerHTML = "";

    try {
      const result = await runFullAnalysis(url);
      renderReport(result);
      statusEl.textContent = "Done! Scroll down for your report";
    } catch (err) {
      statusEl.textContent = "Something went wrong – try again";
      console.error(err);
    } finally {
      runBtn.disabled = false;
    }
  });

  // ─────────────────────── SAFE RENDER FUNCTION (no more crashes) ───────────────────────
  function renderReport(data) {
    // Safely get the best available score
    const mobileScore = data.psi.mobile?.lighthouseResult?.categories?.performance?.score ?? 0;
    const desktopScore = data.psi.desktop?.lighthouseResult?.categories?.performance?.score ?? 0;
    const bestScore = Math.max(mobileScore, desktopScore);
    const scoreNum = bestScore ? Math.round(bestScore * 100) : 0;
    const scoreClass = scoreNum >= 90 ? 'good' : scoreNum >= 50 ? 'avg' : 'poor';

    let html = `
      <div class="card">
        <h2>Overall Score: <span class="score-big ${scoreClass}">${scoreNum || '—'}</span></h2>
        <p>Mobile • Powered by Google PageSpeed + Real-user CrUX data</p>
      </div>
    `;

    // CrUX real-user metrics
    if (data.crux) {
      html += `
        <div class="card">
          <h3>Real-User Experience (CrUX)</h3>
          <p>LCP: <strong>${data.crux.lcp || '—'} ms</strong> • 
             INP: <strong>${data.crux.inp || '—'} ms</strong> • 
             CLS: <strong>${data.crux.cls || '—'}</strong></p>
          <p>Actual visitor data from Chrome users</p>
        </div>`;
    }

    // GTmetrix waterfall
    if (data.gtmetrix) {
      html += `
        <div class="card">
          <h3>Visual Load Timeline (GTmetrix)</h3>
          <p>Fully loaded in <strong>${(data.gtmetrix.fullyLoadedTime / 1000).toFixed(1)}s</strong></p>
          <div class="filmstrip">
            <img src="${data.gtmetrix.report_url}/screenshot.jpg" alt="Load filmstrip" loading="lazy" />
          </div>
        </div>`;
    }

    // Insights
    html += `
      <div class="card insights">
        <h3>Quick Wins & Fixes</h3>
        <ul>
          ${data.insights.map(i => `<li>${i}</li>`).join('') || '<li>Analysis complete – no data yet</li>'}
        </ul>
      </div>
    `;

    reportEl.innerHTML = html;
  }
</script>
</body>
</html>