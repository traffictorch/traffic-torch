<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <!-- Your existing head meta, links, SEO, etc. – unchanged -->
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 flex flex-col">
  <!-- Your header, sidebar, login form, etc. – unchanged -->

  <!-- Unified Upgrade Section -->
  <div class="container mx-auto px-6 py-4 max-w-4xl">
    <header class="text-center mb-16">
      <h1 class="text-3xl md:text-4xl font-extrabold text-center mb-12 bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600">
        Upgrade to Traffic Torch Pro
      </h1>
      <p class="text-gray-800 dark:text-gray-200 mb-12 text-center max-w-3xl mx-auto leading-relaxed">
        Unlock 25 daily AI UX & SEO audit tool runs. Secure login required. Powered by Stripe – privacy-first.
      </p>

      <!-- Login form – unchanged -->

      <!-- Upgrade Section -->
      <div class="bg-gradient-to-br from-orange-500 to-pink-600 text-white rounded-3xl shadow-2xl p-8 max-w-md mx-auto">
        <h3 id="section-title" class="text-2xl font-bold text-center mb-6">Create Account & Upgrade to Pro</h3>

        <!-- Signup form for new users -->
        <form id="signup-form" class="space-y-6">
          <input type="email" id="email" placeholder="Email" required class="w-full p-3 rounded-lg border border-white/30 bg-white/10 text-white placeholder-white/70 focus:outline-none focus:border-white">
          <input type="password" id="password" placeholder="Password" required class="w-full p-3 rounded-lg border border-white/30 bg-white/10 text-white placeholder-white/70 focus:outline-none focus:border-white">
          <button type="submit" id="submit-btn" class="w-full py-4 bg-white text-orange-600 font-bold text-lg rounded-lg hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Create Account & Pay $48/year
          </button>
        </form>

        <!-- Logged-in upgrade button – OUTSIDE form -->
        <div id="pro-upgrade-section" class="hidden mt-8">
          <button type="button" id="upgrade-btn" class="w-full py-4 bg-white text-orange-600 font-bold text-lg rounded-lg hover:bg-gray-100 transition disabled:opacity-50 disabled:cursor-not-allowed">
            Upgrade to Pro – $48/year
          </button>
        </div>

        <!-- Single checkout container -->
        <div id="checkout-container" class="mt-6 min-h-[400px] rounded-lg border border-white/30 bg-white/10 hidden"></div>
        <div id="checkout-errors" class="text-center text-sm text-red-300 min-h-[1.25rem]" role="alert"></div>

        <p class="mt-4 text-center text-sm opacity-90">Secure payment via Stripe • Cancel anytime</p>
      </div>
    </header>

    <!-- Your AddToAny, breadcrumbs, last update, back button, footer – unchanged -->
  </div>

  <!-- Scripts at end -->
  <script src="/main-v1.1.js" type="module"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded – initializing Stripe upgrade');
      const stripe = Stripe('pk_test_51SyjNi35Al6CUgc4F7ASfuA6j5PTrD6bYzeiLSaN8kiFqe3Dx1bEzmR5GjyFmGvqWBu2am8GjFnOgO7WNIno6kdN00jnVWUo9M');
      const API_BASE = 'https://traffic-torch-api.traffictorch.workers.dev';

      const upgradeBtn = document.getElementById('upgrade-btn');
      if (!upgradeBtn) {
        console.error('Upgrade button not found – HTML issue');
        return;
      }
      console.log('Upgrade button found');

      upgradeBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Upgrade clicked');

        const btn = e.target;
        btn.disabled = true;
        btn.textContent = 'Loading...';

        try {
          const token = localStorage.getItem('authToken');
          console.log('Token:', token ? 'exists' : 'missing');
          if (!token) throw new Error('Login required');

          const res = await fetch(API_BASE + '/api/upgrade', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          console.log('API status:', res.status);

          if (!res.ok) throw new Error(await res.text());

          const { client_secret } = await res.json();
          console.log('Client secret OK');

          const container = document.getElementById('checkout-container');
          container.classList.remove('hidden');
          const checkout = await stripe.initEmbeddedCheckout({ clientSecret: client_secret });
          checkout.mount('#checkout-container');
          console.log('Form mounted');
        } catch (err) {
          console.error(err);
          document.getElementById('checkout-errors').textContent = err.message;
          btn.disabled = false;
          btn.textContent = 'Upgrade to Pro – $48/year';
        }
      });

      async function showUpgradeButton() {
        const token = localStorage.getItem('authToken');
        if (!token) return;
        const res = await fetch(API_BASE + '/api/user-status', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) return;
        const { isPro } = await res.json();
        if (!isPro) {
          document.getElementById('pro-upgrade-section').classList.remove('hidden');
          document.getElementById('signup-form').classList.add('hidden');
          document.getElementById('section-title').textContent = 'Upgrade to Pro';
        }
      }
      showUpgradeButton();
    });
  </script>
</body>
</html>